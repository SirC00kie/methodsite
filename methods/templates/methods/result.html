{% extends 'layout/basic.html'  %}

{% block title %} Результат {% endblock %}

{% block content %}
    <h1>Решение системы ОДУ</h1>
    <div class="layer1">
        <h1>Решение уравнений методом {{ methodName }} </h1>
        <table id="resultTable"></table>
        <h1>Экспериментальные данные</h1>
        <table id="expTable"></table>
        <h1></h1>
        <h1>Сравнение результатов в экспериментальных точках</h1>
        <button id="hide-btn-exp"> Скрыть | Показать</button>
        <div id="expTables" style="display: none">
            <p>Метод Эйлера</p>
            <table id="eulerExpTable"></table>
            <p>Неявный метод Эйлера</p>
            <table id="implicitEulerExpTable"></table>
            <p>Метод трапеций</p>
            <table id="trapezoidExpTable"></table>
            <p>Метод средней точки</p>
            <table id="middlePointExpTable"></table>
            <p>Метод Рунге-Кутты 2-го порядка</p>
            <table id="rungeKuttaSecondExpTable"></table>
            <p>Метод Рунге-Кутты 4-го порядка</p>
            <table id="rungeKuttaFourthExpTable"></table>
        </div>
    </div>
    <div class="layer2">
        <h1>График решения уравнений</h1>
        <canvas id="myChart"></canvas>
        <h1></h1>
        <h1>Сравнение методов</h1>
        <button id="hide-btn"> Скрыть | Показать</button>
        <div id="tables" style="display: none">
            <p>Метод Эйлера</p>
            <table id="eulerTable"></table>
            <p>Неявный метод Эйлера</p>
            <table id="implicitEulerTable"></table>
            <p>Метод трапеций</p>
            <table id="trapezoidTable"></table>
            <p>Метод средней точки</p>
            <table id="middlePointTable"></table>
            <p>Метод Рунге-Кутты 2-го порядка</p>
            <table id="rungeKuttaSecondTable"></table>
            <p>Метод Рунге-Кутты 4-го порядка</p>
            <table id="rungeKuttaFourthTable"></table>
        </div>

    </div>
    <div style="display: none" id="expData" data-json="{{ expData }}"></div>
    <div style="display: none" id="allMethodsData" data-json="{{ allMethodsData }}"></div>
    <div style="display: none" id="selectedMethodData" data-json="{{ selectedMethodData }}"></div>
    <div style="display: none" id="allMethodsExpData" data-json="{{ allMethodsExpData }}"></div>
    <script>

        function loadJson(selector) {
          return JSON.parse((document.querySelector(selector).getAttribute('data-json')));
        }

        let steps = [];
        let expData = loadJson('#expData');
        let allMethodsData = loadJson('#allMethodsData');
        let selectedMethodData = loadJson('#selectedMethodData');
        let allMethodsExpData = loadJson('#allMethodsExpData');
        let headerRes = ["№","t"];

        console.log(expData)
        function createTable(id, data, header) {
          let table = document.getElementById(id);
          for( let i = 0; i < 1; i++ ) {
              let tr = document.createElement('tr')

            for (let j = 0; j < header.length; j++){
                let th = document.createElement('th')
                th.innerHTML = header[j];
                tr.appendChild(th)
            }
            let count = 1;
            for (let j = header.length; j <= data[0].length; j++){
                let th = document.createElement('th');
                th.innerHTML = "A" + count;
                tr.appendChild(th);
                count++;
            }
            table.appendChild(tr)
          }

          for( let i = 0; i < data.length; i++ ) {
              let tr = document.createElement('tr')

            for (let j = 0; j < data[0].length + 1; j++){
                let td = document.createElement('td');
                if (j===0) td.innerHTML = i;
                else td.innerHTML = data[i][j-1].toFixed(5);
                tr.appendChild(td)
            }
            table.appendChild(tr)
          }
        }

        createTable('expTable', expData, headerRes)
        createTable('resultTable', selectedMethodData, headerRes)
        createTable('eulerTable', allMethodsData["метод Эйлера"], headerRes)
        createTable('implicitEulerTable', allMethodsData["Неявный метод Эйлера"], headerRes)
        createTable('trapezoidTable', allMethodsData["Метод трапеций"], headerRes)
        createTable('middlePointTable', allMethodsData["Метод средней точки"], headerRes)
        createTable('rungeKuttaSecondTable', allMethodsData["Метод Рунге-Кутты 2-го порядка"], headerRes)
        createTable('rungeKuttaFourthTable', allMethodsData["Метод Рунге-Кутты 4-го порядка"], headerRes)
        createTable('eulerExpTable', allMethodsExpData["метод Эйлера экспериментальные"], headerRes)
        createTable('implicitEulerExpTable', allMethodsExpData["Неявный метод Эйлера экспериментальные"], headerRes)
        createTable('trapezoidExpTable', allMethodsExpData["Метод трапеций экспериментальные"], headerRes)
        createTable('middlePointExpTable', allMethodsExpData["Метод средней точки экспериментальные"], headerRes)
        createTable('rungeKuttaSecondExpTable', allMethodsExpData["Метод Рунге-Кутты 2-го порядка экспериментальные"], headerRes)
        createTable('rungeKuttaFourthExpTable', allMethodsExpData["Метод Рунге-Кутты 4-го порядка экспериментальные"], headerRes)

        for (let i = 0; i < selectedMethodData.length; i++) {
            steps[i] = selectedMethodData[i][0].toFixed(3)
        }

        const transpose = matrix => matrix[0].map((col, i) => matrix.map(row => row[i]));

        const transposedMatrix = transpose(selectedMethodData);
        transposedMatrix.splice(0,1);

        let arrColoros = ["red", "blue", "green", "orange", "aqua", "purple", "gray", "deeppink", "khaki", "indigo", "maroon", "midnightblue", "olive", "salmon", "sienna", "thistle", "tomato" ]

        let ctx = document.getElementById('myChart').getContext('2d');
        let myChart = new Chart(ctx,{
            type: 'line',
            data: {
                labels: steps,
                datasets: [{
                    id:'1'
                }],
            },
            options: {
                responsive: true
            }
        });

        transposedMatrix.forEach(function (a, i) {
            myChart.data.datasets.push({
                label: 'A ' + (i+1),
                borderColor: arrColoros[i],
                backgroundColor: arrColoros[i],
                pointBorderColor:'black',
                pointBackgroundColor:arrColoros[i],
                borderWidth: 1,
                pointRadius: 2.5,
                data: transposedMatrix[i]
            });
        });

        myChart.data.datasets.find((dataset, index) => {
            if (dataset.id === '1') {
               myChart.data.datasets.splice(index, 1);
               return true;
            }
        });
        myChart.update();

        document.getElementById('hide-btn').onclick = function() {
          let el = document.getElementById('tables');
          el.style.display === 'none' ? el.style.display = 'initial' : el.style.display = 'none';
        }
        document.getElementById('hide-btn-exp').onclick = function() {
          let el = document.getElementById('expTables');
          el.style.display === 'none' ? el.style.display = 'initial' : el.style.display = 'none';
        }
    </script>
{% endblock %}
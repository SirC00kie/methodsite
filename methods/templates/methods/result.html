{% extends 'layout/basic.html'  %}

{% block title %} Результат {% endblock %}

{% block content %}
    <h1>Решение системы ОДУ</h1>
<div class="layer1">
    <h1>Решение уравнений методом {{ method_name }} </h1>
    <table id="result_table">
        {% for row in data %}
            <tr>
            {% for cell in row %}
                <td>{{ cell|floatformat:5 }}</td>

            {% endfor %}
            </tr>
        {% endfor %}
    </table>
</div>
<div class="layer2">
    <h1>График решения уравнений</h1>
    <canvas id="myChart"></canvas>
    <h1>Экперементальные данные</h1>
    <table id="expDat"></table>
</div>
<div style="display: none" id="jsonData" data-json="{{ json_dump }}"></div>
<div style="display: none" id="jsonExp" data-json="{{ json_exp }}"></div>
<script>
    function loadJson(selector) {
      return JSON.parse(document.querySelector(selector).getAttribute('data-json'));
    }

    var steps = []
    var jsonData = loadJson('#jsonData');
    var jsonExp = loadJson('#jsonExp');

    function convertArr(arr, cols) { // cols - указывает на количество элементов в подмассиве
        let resultArr = [];

    // будем пушить и резать массив, пока не опустошим его полностью
        while(arr.length > 0) {
            resultArr.push(arr.slice(0, cols)); // пушим первые элементы исходного массива в новый
            arr.splice(0, cols) // удаляем запушенные элементы из исходного массива
        }
    // вернем новый массив
        return resultArr;
    }

    {% for m in matrix %}
        var components = {{ m.components }}
        var stages = {{ m.stages }}
        var experients = {{ m.experients }}
    {% endfor %}

    var exp_table = convertArr(jsonExp['exp_table'], components+1);

    const expDat = document.getElementById('expDat');

    const result_table = document.getElementById('result_table');
    var row = result_table.insertRow(0);
    for (let i = 0; i <= components; i++) {
        var cell = row.insertCell(0);
        if (i != components) cell.appendChild(document.createTextNode('A' + (components-i)));
        else cell.appendChild(document.createTextNode('t'))
    }

    for (var i = 0; i < experients + 1; i++) {
        var tr = document.createElement('tr');
        for (var j = 0; j < components + 2; j++) {
            var td = document.createElement('td');
            if (i>0 && j>0) td.innerHTML = exp_table[i-1][j-1];
            tr.appendChild(td);
            var jj = j-1;
            if ((i == 0) && (j == 1)) td.innerHTML = "t";
            else if (i == 0) td.innerHTML = "A" + jj;
            if ((j == 0) && (i!=0) )td.innerHTML = i;
            else if ((j == 0) && (i==0)) td.innerHTML = "№";
        }
        expDat.appendChild(tr);
    }
    var td = document.querySelectorAll('td');

    for (let i = 0; i < jsonData['data'].length; i++) {
        steps[i] = jsonData['data'][i][0].toFixed(5)
    }
    const transpose = matrix => matrix[0].map((col, i) => matrix.map(row => row[i]));

    const transposedMatrix = transpose(jsonData['data']);
    transposedMatrix.splice(0,1);

    var arrColoros = ["red", "blue", "green", "orange", "aqua", "purple", "gray", "deeppink", "khaki", "indigo", "maroon", "midnightblue", "olive", "salmon", "sienna", "thistle", "tomato" ]

    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx,{
        type: 'line',
        data: {
            labels: steps,
            datasets: [{
                id:'1'
            }],

        },
        options: {
            responsive: true
        }
    });


    transposedMatrix.forEach(function (a, i) {
        myChart.data.datasets.push({
            label: 'A ' + (i+1),
            borderColor: arrColoros[i],
            backgroundColor: arrColoros[i],
            pointBorderColor:'black',
            pointBackgroundColor:arrColoros[i],
            borderWidth: 1,
            pointRadius: 2.5,
            data: transposedMatrix[i]
        });
    });
    console.log(myChart.data);

    myChart.data.datasets.find((dataset, index) => {
        if (dataset.id === '1') {
           myChart.data.datasets.splice(index, 1);
           return true; // stop searching
        }
    });
    myChart.update();

</script>
{% endblock %}